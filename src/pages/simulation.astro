---
import { Container, TextSection } from '@components/odyssey-theme';
import Layout from '../layouts/Page.astro';

const seo = {
	title: 'Simulate | NMES for Astronauts',
	description: 'Visualize the effects of microgravity on muscle tissue over time.',
};
---

<Layout seo={seo}>
	<Container>
		<TextSection narrow>
			<h1 style="text-align: center;">Muscle Atrophy Simulator</h1>
			<p style="text-align: center;">
				<strong>Visualize</strong> how a human thigh muscle changes over 6 months in space. <strong>Compare</strong> the effects of doing <strong>nothing</strong>, <strong>exercising</strong>, and using <strong>NMES</strong>.
			</p>

      <div class="simulator-container">
        <div class="controls">
          <div class="control-group">
            <label for="days">Days in Space: <span id="days-val">0</span></label>
            <input type="range" id="days" min="0" max="180" value="0">
          </div>

          <div class="control-group">
            <label>Countermeasure Strategy:</label>
            <div class="radio-group">
              <label><input type="radio" name="strategy" value="none" checked> None</label>
              <label><input type="radio" name="strategy" value="exercise"> Exercise Only</label>
              <label><input type="radio" name="strategy" value="nmes"> NMES + Exercise</label>
            </div>
          </div>
        </div>

        <div class="visualization">
          <div id="muscle-cross-section" class="muscle-circle">
            <div class="muscle-inner"></div>
            <div class="bone"></div>
          </div>
          <div class="stats">
            <div class="stat">
              <span class="label">Muscle Mass</span>
              <span id="mass-val" class="value">100%</span>
            </div>
            <div class="stat">
              <span class="label">Fat Infiltration</span>
              <span id="fat-val" class="value">0%</span>
            </div>
          </div>
        </div>
        
        <div id="feedback" class="feedback">
          Day 0: Launch day. Muscle health is optimal.
        </div>
      </div>

      <div class="nav-button-container">
        <a href="/assessment" class="nav-arrow" aria-label="Next: Assessment">
          <span class="nav-label">NEXT</span>
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="5" y1="12" x2="19" y2="12"></line>
            <polyline points="12 5 19 12 12 19"></polyline>
          </svg>
        </a>
      </div>
		</TextSection>
	</Container>
</Layout>

<style>
  .simulation-container {
    margin-top: 2rem;
  }
  .nav-button-container {
    display: flex;
    justify-content: center;
    margin-top: 2rem;
    padding-bottom: 2rem;
  }
  .nav-arrow {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    color: var(--theme-on-bg);
    opacity: 0.5;
    transition: all var(--theme-transition);
    text-decoration: none;
  }
  .nav-arrow:hover {
    color: var(--theme-primary);
    opacity: 1;
    transform: scale(1.1);
    filter: drop-shadow(0 0 5px var(--theme-primary));
  }
  .nav-arrow svg {
    width: 48px;
    height: 48px;
  }
  .nav-label {
    font-size: 1.5rem;
    font-weight: 700;
    margin-right: 0.5rem;
    letter-spacing: 2px;
  }
  .simulator-container {
    border: 2px solid var(--theme-surface-2);
    border-radius: var(--theme-shape-radius);
    padding: 2rem;
    margin-top: 2rem;
    display: flex;
    flex-direction: column;
    gap: 2rem;
  }

  .controls {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .control-group label {
    font-weight: bold;
    display: block;
    margin-bottom: 0.5rem;
  }

  /* Custom Range Slider */
  input[type=range] {
    -webkit-appearance: none;
    width: 100%;
    background: transparent;
  }

  input[type=range]::-webkit-slider-thumb {
    -webkit-appearance: none;
    height: 20px;
    width: 20px;
    border-radius: 50%;
    background: var(--theme-primary);
    cursor: pointer;
    margin-top: -8px;
    box-shadow: 0 0 5px rgba(0,0,0,0.2);
  }

  input[type=range]::-moz-range-thumb {
    height: 20px;
    width: 20px;
    border-radius: 50%;
    background: var(--theme-primary);
    cursor: pointer;
    border: none;
    box-shadow: 0 0 5px rgba(0,0,0,0.2);
  }

  input[type=range]::-webkit-slider-runnable-track {
    width: 100%;
    height: 4px;
    cursor: pointer;
    background: var(--theme-surface-2);
    border-radius: 2px;
  }

  input[type=range]::-moz-range-track {
    width: 100%;
    height: 4px;
    cursor: pointer;
    background: var(--theme-surface-2);
    border-radius: 2px;
  }

  /* Custom Radio Buttons */
  .radio-group {
    display: flex;
    gap: 1.5rem;
    flex-wrap: wrap;
  }

  .radio-group label {
    font-weight: normal;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    position: relative;
  }

  .radio-group input[type="radio"] {
    appearance: none;
    -webkit-appearance: none;
    width: 20px;
    height: 20px;
    border: 2px solid var(--theme-surface-2);
    border-radius: 50%;
    margin: 0;
    display: grid;
    place-content: center;
    transition: all 0.2s ease;
  }

  .radio-group input[type="radio"]::before {
    content: "";
    width: 10px;
    height: 10px;
    border-radius: 50%;
    transform: scale(0);
    transition: 120ms transform ease-in-out;
    box-shadow: inset 1em 1em var(--theme-primary);
  }

  .radio-group input[type="radio"]:checked {
    border-color: var(--theme-primary);
  }

  .radio-group input[type="radio"]:checked::before {
    transform: scale(1);
  }

  .radio-group label:hover input[type="radio"] {
    border-color: var(--theme-primary);
  }

  .visualization {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2rem;
    padding: 2rem;
    background: var(--theme-surface-1);
    border-radius: 8px;
  }

  .muscle-circle {
    width: 200px;
    height: 200px;
    background-color: #ffcccc; /* Fat/Skin color */
    border-radius: 50%;
    position: relative;
    display: flex;
    justify-content: center;
    align-items: center;
    transition: all 0.3s ease;
  }

  .muscle-inner {
    width: 180px;
    height: 180px;
    background-color: #ff6b6b; /* Muscle color */
    border-radius: 50%;
    position: absolute;
    transition: all 0.3s ease;
  }

  .bone {
    width: 40px;
    height: 40px;
    background-color: #f5f5f5;
    border: 2px solid #e0e0e0;
    border-radius: 50%;
    z-index: 10;
  }

  .stats {
    display: flex;
    gap: 2rem;
    width: 100%;
    justify-content: center;
  }

  .stat {
    text-align: center;
  }

  .stat .label {
    display: block;
    font-size: 0.9rem;
    color: #666;
  }

  .stat .value {
    font-size: 1.5rem;
    font-weight: bold;
  }

  .feedback {
    font-style: italic;
    text-align: center;
    min-height: 1.5em;
  }
</style>

<script>
  const daysInput = document.getElementById('days') as HTMLInputElement;
  const daysVal = document.getElementById('days-val');
  const strategyInputs = document.querySelectorAll('input[name="strategy"]');
  const muscleInner = document.querySelector('.muscle-inner') as HTMLElement;
  const massVal = document.getElementById('mass-val');
  const fatVal = document.getElementById('fat-val');
  const feedback = document.getElementById('feedback');

  function update() {
    const days = parseInt(daysInput.value);
    daysVal.textContent = days.toString();
    
    let strategy = 'none';
    strategyInputs.forEach((input) => {
      const radioInput = input as HTMLInputElement;
      if (radioInput.checked) strategy = radioInput.value;
    });

    // Calculate atrophy rate based on strategy
    // None: 30% loss over 180 days (0.16% per day)
    // Exercise: 15% loss over 180 days (0.08% per day)
    // NMES: 5% loss over 180 days (0.02% per day)
    
    let lossRate = 0;
    if (strategy === 'none') lossRate = 0.30;
    else if (strategy === 'exercise') lossRate = 0.15;
    else if (strategy === 'nmes') lossRate = 0.05;

    const currentLoss = (days / 180) * lossRate;
    const massPercentage = 100 - (currentLoss * 100);
    const fatPercentage = currentLoss * 100; // Simplified: fat replaces muscle space

    // Update Visuals
    // Max size is 180px (90% of container). Min size depends on loss.
    // If 30% loss, size becomes 70% of original.
    const originalSize = 180;
    const newSize = originalSize * (massPercentage / 100);
    
    muscleInner.style.width = `${newSize}px`;
    muscleInner.style.height = `${newSize}px`;
    
    // Change color slightly to indicate health
    if (massPercentage < 80) {
      muscleInner.style.backgroundColor = '#ff8787'; // paler red
    } else {
      muscleInner.style.backgroundColor = '#ff6b6b'; // healthy red
    }

    // Update Text
    massVal.textContent = `${massPercentage.toFixed(1)}%`;
    fatVal.textContent = `${fatPercentage.toFixed(1)}%`;

    // Feedback
    if (days === 0) {
      feedback.textContent = "Day 0: Launch day. Muscle health is optimal.";
    } else if (massPercentage < 80) {
      feedback.textContent = "Critical muscle loss detected. Risk of injury high.";
    } else if (massPercentage < 90) {
      feedback.textContent = "Moderate atrophy. Performance may be impacted.";
    } else {
      feedback.textContent = "Muscle mass well-maintained. Mission ready.";
    }
  }

  daysInput.addEventListener('input', update);
  strategyInputs.forEach(input => input.addEventListener('change', update));

  // Initial call
  update();
</script>
