---
import { Container, TextSection } from '@components/odyssey-theme';
import Layout from '../layouts/Page.astro';

const seo = {
	title: 'NMES Simulation | NMES for Astronauts',
	description: 'Interactive NMES Simulation Tool',
};
---

<Layout seo={seo}>
	<Container>
		<TextSection narrow>
			<h1>NMES Simulation</h1>
			<p>
				Use the controls below to simulate how Neuromuscular Electrical Stimulation (NMES) affects muscle fibers. Adjust the frequency and intensity to see the response.
			</p>

      <div class="simulation-container">
        <div class="controls">
          <div class="control-group">
            <label for="frequency">Frequency (Hz)</label>
            <input type="range" id="frequency" min="1" max="100" value="10">
            <span id="freq-val">10 Hz</span>
          </div>
          <div class="control-group">
            <label for="intensity">Intensity (mA)</label>
            <input type="range" id="intensity" min="1" max="100" value="20">
            <span id="int-val">20 mA</span>
          </div>
          <button id="start-btn">Start Stimulation</button>
        </div>

        <div class="visualizer">
          <div id="muscle" class="muscle">
            <div class="fiber"></div>
            <div class="fiber"></div>
            <div class="fiber"></div>
          </div>
          <div id="status">Status: Idle</div>
        </div>
      </div>
		</TextSection>
	</Container>
</Layout>

<style>
  .simulation-container {
    border: 2px solid var(--theme-surface-2);
    border-radius: var(--theme-shape-radius);
    padding: 2rem;
    margin-top: 2rem;
    display: grid;
    gap: 2rem;
  }

  .controls {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .control-group {
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .control-group label {
    width: 120px;
    font-weight: bold;
  }

  .control-group input {
    flex: 1;
  }

  .visualizer {
    background: #f0f0f0;
    padding: 2rem;
    border-radius: 8px;
    text-align: center;
  }

  .muscle {
    width: 100%;
    height: 100px;
    background: #e0e0e0;
    border-radius: 50px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    gap: 5px;
    padding: 10px;
    transition: transform 0.1s ease;
  }

  .fiber {
    height: 10px;
    background: #ff6b6b;
    border-radius: 5px;
    width: 100%;
  }

  #status {
    margin-top: 1rem;
    font-weight: bold;
    color: #333;
  }

  /* Animation classes */
  .twitch {
    animation: twitch 0.1s ease;
  }

  .tetanus {
    transform: scaleX(0.9);
    background: #ff4040;
  }

  @keyframes twitch {
    0% { transform: scaleX(1); }
    50% { transform: scaleX(0.95); }
    100% { transform: scaleX(1); }
  }
</style>

<script>
  const frequencyInput = document.getElementById('frequency');
  const intensityInput = document.getElementById('intensity');
  const freqVal = document.getElementById('freq-val');
  const intVal = document.getElementById('int-val');
  const startBtn = document.getElementById('start-btn');
  const muscle = document.getElementById('muscle');
  const status = document.getElementById('status');

  let isRunning = false;
  let intervalId = null;

  frequencyInput.addEventListener('input', (e) => {
    freqVal.textContent = `${e.target.value} Hz`;
    if (isRunning) restartSimulation();
  });

  intensityInput.addEventListener('input', (e) => {
    intVal.textContent = `${e.target.value} mA`;
  });

  startBtn.addEventListener('click', () => {
    if (isRunning) {
      stopSimulation();
    } else {
      startSimulation();
    }
  });

  function startSimulation() {
    isRunning = true;
    startBtn.textContent = 'Stop Stimulation';
    const freq = parseInt(frequencyInput.value);
    const intensity = parseInt(intensityInput.value);

    status.textContent = `Stimulating at ${freq} Hz, ${intensity} mA`;

    // Calculate interval in ms
    const interval = 1000 / freq;

    if (freq >= 20) {
      // Tetanic contraction (sustained)
      muscle.classList.add('tetanus');
      status.textContent += ' - Tetanic Contraction';
    } else {
      // Twitch contraction
      intervalId = setInterval(() => {
        muscle.classList.add('twitch');
        setTimeout(() => muscle.classList.remove('twitch'), 50);
      }, interval);
      status.textContent += ' - Twitch Contraction';
    }
  }

  function stopSimulation() {
    isRunning = false;
    startBtn.textContent = 'Start Stimulation';
    clearInterval(intervalId);
    muscle.classList.remove('tetanus');
    muscle.classList.remove('twitch');
    status.textContent = 'Status: Idle';
  }

  function restartSimulation() {
    stopSimulation();
    startSimulation();
  }
</script>
